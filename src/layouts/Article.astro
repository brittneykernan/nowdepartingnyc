---
import Layout from "./Layout.astro";
import { LocationMenuImages } from "../data/MenuImages";
import Card from "../components/Card.astro";
import Footer from "../components/Footer.astro";
import ArticleList from "../components/ArticleList.astro";
import NextUp from "../components/NextUp.astro";
import Thanks from "../components/Thanks.astro";
import type { Code, Debug } from "astro:components";

const {
  frontmatter: { title, guide, urlPath },
} = Astro.props;

const locationImage = LocationMenuImages[guide];
const { artistName, url, alt } = locationImage;

const articlePath = `/src/pages/${guide}`;
const guideHref = `\\${guide}`;

const allArticles = await Astro.glob(`../**/*.md`);
const articlesInGuide = allArticles.filter((article) =>
  article.file.includes(articlePath)
);

const nextArticle = articlesInGuide.find((_, index) => {
  const lastArticle = articlesInGuide[articlesInGuide.length - 1].url;
  const nextArticle = articlesInGuide[index - 1]?.url;
  if (
    urlPath === lastArticle || // if current is last article in list, return first article, which is first article tested
    urlPath === nextArticle // otherwise return next article
  ) {
    return true;
  } else return false;
});
---

<Layout title={`${title} | Now Departing NYC`}>
  <main class="headerOffset">
    <div class="left-rail">
      <Card
        image={locationImage}
        height={900}
        href={guideHref}
        title={title}
        transitionName={guide}
        hideTitle
        responsive
      />
      {
        artistName && url && (
          <small class="imageCredit">
            <a href={url} target="_blank" rel="nofollow noreferrer noopener">
              {alt}
            </a>
          </small>
        )
      }
    </div>
    <article class="article">
      <slot />
      <ArticleList articles={articlesInGuide} currentURLPath={urlPath} />
      <NextUp {...nextArticle} />
      <Thanks />
    </article>
  </main>
  <Footer />
</Layout>

<style>
  main {
    display: flex;
    flex-direction: column;
    padding: 0 var(--space-l);
  }
  @media screen and (min-width: 768px) {
    main {
      padding: 0 var(--space-xl);
    }
  }
</style>
<script type="text/javascript">
  // To open Mardown links in a new tab
  // todo: add norel no referrer
  !(function () {
    for (
      var e = document.body.getElementsByTagName("a"), t = e.length, n = 0;
      n < t;
      n++
    )
      new URL(e[n].href).origin !== location.origin &&
        e[n].setAttribute("target", "_blank");
  })();
</script>
